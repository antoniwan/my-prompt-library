---
import "../styles/global.css";
import ThemeToggle from "../components/ThemeToggle.astro";
import SearchBar from "../components/SearchBar.astro";
import BackToTop from "../components/BackToTop.astro";
import { home, promptsIndex, tagsIndex, searchPage } from "../utils/urls";
import {
  SITE_NAME,
  DEFAULT_DESCRIPTION,
  SITE_AUTHOR,
  TWITTER_HANDLE,
  OG_IMAGE_WIDTH,
  OG_IMAGE_HEIGHT,
  OG_IMAGE_ALT,
} from "../data/site";
import pkg from "../../package.json";

interface Props {
  title?: string;
  description?: string;
  canonicalPath?: string;
  /** Single JSON-LD object or array of objects (e.g. Article + BreadcrumbList). */
  structuredData?: object | object[];
  ogType?: "website" | "article";
  /** When true, adds robots noindex,nofollow (e.g. 404). */
  noindex?: boolean;
  /** Optional comma-separated or single keywords for meta keywords. */
  keywords?: string;
}

const {
  title = SITE_NAME,
  description = DEFAULT_DESCRIPTION,
  canonicalPath,
  structuredData,
  ogType = "website",
  noindex = false,
  keywords,
} = Astro.props;

const canonicalHref =
  Astro.site && canonicalPath ? new URL(canonicalPath, Astro.site).href : undefined;
const ogImageHref = Astro.site ? new URL("/share-image.png", Astro.site).href : undefined;
const jsonLdItems =
  structuredData != null
    ? (Array.isArray(structuredData) ? structuredData : [structuredData]).map((item) =>
        JSON.stringify(item).replace(/<\/script>/gi, "<\\/script>")
      )
    : [];

const criticalCSS = `:root,[data-theme="dark"]{--color-background:#0f172a;--color-foreground:#fff;--color-muted:#e2e8f0;--color-border:#334155;--color-surface:#0f172a;--color-surface-hover:#1e293b;--color-accent:#0070f3;--color-accent-subtle:rgba(0,112,243,.08);--color-accent-border:rgba(0,112,243,.25)}[data-theme="light"]{--color-background:#fff;--color-foreground:#171717;--color-muted:#737373;--color-border:#e5e5e5;--color-surface:#fafafa;--color-surface-hover:#f5f5f5;--color-accent-subtle:rgba(0,112,243,.06);--color-accent-border:rgba(0,112,243,.35)}body{background:var(--color-background);color:var(--color-foreground);font-family:system-ui,sans-serif;line-height:1.6;margin:0;min-height:100vh}`;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <style is:inline set:html={criticalCSS}></style>
    <script is:inline>
      (function () {
        try {
          const stored = localStorage.getItem("theme");
          const theme =
            stored === "light" || stored === "dark"
              ? stored
              : window.matchMedia("(prefers-color-scheme: dark)").matches
                ? "dark"
                : "light";
          document.documentElement.setAttribute("data-theme", theme);
        } catch {
          /* Theme init may fail in restricted contexts */
        }
      })();
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      rel="preload"
      href="https://fonts.googleapis.com/css2?family=Geist:wght@400;500;600;700&family=Geist+Mono:wght@400;500&display=swap"
      as="style"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Geist:wght@400;500;600;700&family=Geist+Mono:wght@400;500&display=swap"
      rel="stylesheet"
    />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="icon" href="/favicon.ico" />
    <meta name="generator" content={Astro.generator} />
    <meta name="author" content={SITE_AUTHOR.name} />
    <meta name="application-name" content={SITE_NAME} />
    {noindex && <meta name="robots" content="noindex,nofollow" />}
    <meta name="description" content={description} />
    {keywords && <meta name="keywords" content={keywords} />}
    {canonicalHref && <link rel="canonical" href={canonicalHref} />}
    <meta property="og:site_name" content={SITE_NAME} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content={ogType} />
    <meta property="og:locale" content="en" />
    {canonicalHref && <meta property="og:url" content={canonicalHref} />}
    {ogImageHref && (
      <>
        <meta property="og:image" content={ogImageHref} />
        <meta property="og:image:width" content={String(OG_IMAGE_WIDTH)} />
        <meta property="og:image:height" content={String(OG_IMAGE_HEIGHT)} />
        <meta property="og:image:alt" content={OG_IMAGE_ALT} />
      </>
    )}
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content={`@${TWITTER_HANDLE}`} />
    <meta name="twitter:creator" content={`@${TWITTER_HANDLE}`} />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    {ogImageHref && <meta name="twitter:image" content={ogImageHref} />}
    <meta name="theme-color" content="#0f172a" media="(prefers-color-scheme: dark)" />
    <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)" />
    <title>{title}</title>
    {jsonLdItems.map((safe) => (
      <script type="application/ld+json" set:html={safe} />
    ))}
  </head>
  <body class="flex min-h-screen flex-col">
    <a href="#main" class="skip-link">Skip to main content</a>

    <header
      class="sticky top-0 z-50 flex h-14 w-full items-center border-b-2 border-b-[var(--color-accent-border)] border-x-0 border-t-0 bg-[var(--color-background)]/80 backdrop-blur-md"
      role="banner"
    >
      <nav class="mx-auto flex w-full max-w-4xl items-center gap-6 px-4 sm:px-6" aria-label="Main">
        <a
          href={home()}
          class="shrink-0 text-lg font-semibold tracking-tight text-[var(--color-foreground)] no-underline hover:text-[var(--color-accent)] focus-visible:text-[var(--color-accent)]"
        >
          MPL
        </a>
        <ul class="flex shrink-0 list-none gap-4 p-0 sm:gap-6">
          <li>
            <a
              href={promptsIndex()}
              class="text-sm text-[var(--color-muted)] no-underline hover:text-[var(--color-foreground)] focus-visible:text-[var(--color-accent)]"
            >
              Prompts
            </a>
          </li>
          <li>
            <a
              href={tagsIndex()}
              class="text-sm text-[var(--color-muted)] no-underline hover:text-[var(--color-foreground)] focus-visible:text-[var(--color-accent)]"
            >
              Tags
            </a>
          </li>
          <li>
            <a
              href={searchPage()}
              class="text-sm text-[var(--color-muted)] no-underline hover:text-[var(--color-foreground)] focus-visible:text-[var(--color-accent)]"
            >
              Search
            </a>
          </li>
        </ul>
        <div class="min-w-0 flex-1 px-2 sm:mx-4 sm:max-w-md">
          <SearchBar class="w-full" />
        </div>
        <ThemeToggle />
      </nav>
    </header>

    <main id="main" class="flex-1 px-4 pb-16 pt-8 sm:px-6">
      <div class="mx-auto max-w-3xl">
        <slot />
      </div>
    </main>

    <footer
      class="shrink-0 border-t border-[var(--color-border)] bg-[var(--color-surface)] py-6"
      role="contentinfo"
    >
      <div class="flex flex-col items-center justify-center gap-1 text-center sm:flex-row sm:gap-3">
        <p class="m-0 text-xs text-[var(--color-muted)]">
          {SITE_NAME} — Markdown prompts in a Git repo, portable by design.
        </p>
        <span class="hidden text-[var(--color-border)] sm:inline" aria-hidden="true">·</span>
        <p class="m-0 text-xs text-[var(--color-muted)]">
          v{pkg.version}
        </p>
        <span class="hidden text-[var(--color-border)] sm:inline" aria-hidden="true">·</span>
        <a
          href="https://github.com/antoniwan/my-prompt-library"
          target="_blank"
          rel="noopener noreferrer"
          class="text-xs text-[var(--color-muted)] no-underline hover:text-[var(--color-accent)] focus-visible:text-[var(--color-accent)]"
        >
          Source code on GitHub
        </a>
      </div>
    </footer>
    <BackToTop />
    <script>
      import { inject } from "@vercel/analytics";
      inject();
    </script>
  </body>
</html>

<style is:global>
  /* Layout uses design tokens from global.css; theme toggle targets .theme-toggle */
  .theme-toggle {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 2.25rem;
    height: 2.25rem;
    padding: 0;
    background: transparent;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    color: var(--color-muted);
    cursor: pointer;
    flex-shrink: 0;
  }
  .theme-toggle:hover,
  .theme-toggle:focus-visible {
    color: var(--color-accent);
    border-color: var(--color-accent);
  }
</style>
