---
import Layout from "../../layouts/Layout.astro";
import PageHeader from "../../components/PageHeader.astro";
import PromptCard from "../../components/PromptCard.astro";
import { getCollection } from "astro:content";

const tagFilter = Astro.url.searchParams.get("tag");
const difficultyFilter = Astro.url.searchParams.get("difficulty");
const authorFilter = Astro.url.searchParams.get("author");
let prompts = await getCollection("prompts", ({ data }) => data.visibility === "public");

if (tagFilter) {
  prompts = prompts.filter((p) => p.data.tags.includes(tagFilter));
}
if (difficultyFilter && ["beginner", "intermediate", "advanced"].includes(difficultyFilter)) {
  prompts = prompts.filter((p) => p.data.difficulty === difficultyFilter);
}
if (authorFilter) {
  prompts = prompts.filter((p) => p.data.author === authorFilter);
}

prompts = prompts.sort(
  (a, b) => new Date(b.data.updated_at).getTime() - new Date(a.data.updated_at).getTime(),
);

const hasFilters = !!(tagFilter || difficultyFilter || authorFilter);

const allPrompts = await getCollection("prompts", ({ data }) => data.visibility === "public");
const tagSet = new Set<string>();
const authorSet = new Set<string>();
for (const entry of allPrompts) {
  entry.data.tags.forEach((t: string) => tagSet.add(t));
  authorSet.add(entry.data.author);
}
const tags = Array.from(tagSet).sort((a, b) => a.localeCompare(b));
const authors = Array.from(authorSet).sort((a, b) => a.localeCompare(b));
const difficulties = ["beginner", "intermediate", "advanced"] as const;
---

<Layout
  title="Prompts — My Prompt Library"
  description="Browse all curated prompts. Filter by tag, difficulty, and author."
>
  <PageHeader
    title="Prompts"
    description="Browse and filter prompts by tag, difficulty, or author."
  >
    {hasFilters && (
      <p class="m-0 mt-1">
        Filtering by:{" "}
        {[
          tagFilter && `tag ${tagFilter}`,
          difficultyFilter && `difficulty ${difficultyFilter}`,
          authorFilter && `author ${authorFilter}`,
        ]
          .filter(Boolean)
          .join(" · ")}{" "}
        — <a href="/prompts/" class="text-[var(--color-accent)] hover:underline">Clear filters</a>
      </p>
    )}
  </PageHeader>

  <div class="mb-6 flex flex-wrap items-center gap-3 rounded-lg border border-[var(--color-border)] bg-[var(--color-surface)] p-4">
    <span class="text-xs font-medium uppercase tracking-wider text-[var(--color-muted)]">
      Filters
    </span>
    <form method="get" action="/prompts/" class="flex flex-wrap items-center gap-3">
      <label for="filter-difficulty" class="sr-only">Difficulty</label>
      <select
        id="filter-difficulty"
        name="difficulty"
        class="rounded-md border border-[var(--color-border)] bg-[var(--color-background)] px-3 py-1.5 text-sm text-[var(--color-foreground)] focus:border-[var(--color-accent)]"
        aria-label="Filter by difficulty"
      >
        <option value="">All difficulties</option>
        {difficulties.map((d) => (
          <option value={d} selected={difficultyFilter === d}>
            {d}
          </option>
        ))}
      </select>
      <label for="filter-author" class="sr-only">Author</label>
      <select
        id="filter-author"
        name="author"
        class="rounded-md border border-[var(--color-border)] bg-[var(--color-background)] px-3 py-1.5 text-sm text-[var(--color-foreground)] focus:border-[var(--color-accent)]"
        aria-label="Filter by author"
      >
        <option value="">All authors</option>
        {authors.map((a) => (
          <option value={a} selected={authorFilter === a}>
            {a}
          </option>
        ))}
      </select>
      <label for="filter-tag" class="sr-only">Tag</label>
      <select
        id="filter-tag"
        name="tag"
        class="rounded-md border border-[var(--color-border)] bg-[var(--color-background)] px-3 py-1.5 text-sm text-[var(--color-foreground)] focus:border-[var(--color-accent)]"
        aria-label="Filter by tag"
      >
        <option value="">All tags</option>
        {tags.map((t) => (
          <option value={t} selected={tagFilter === t}>
            {t}
          </option>
        ))}
      </select>
      <button
        type="submit"
        class="rounded-md bg-[var(--color-accent)] px-3 py-1.5 text-sm font-medium text-white hover:opacity-90"
      >
        Apply
      </button>
      {hasFilters && (
        <a
          href="/prompts/"
          class="rounded-md border border-[var(--color-border)] px-3 py-1.5 text-sm text-[var(--color-muted)] no-underline hover:text-[var(--color-foreground)]"
        >
          Clear
        </a>
      )}
    </form>
  </div>

  <ul class="list-none space-y-4 p-0" aria-label="List of prompts">
    {prompts.map((entry) => (
      <li>
        <PromptCard entry={entry} />
      </li>
    ))}
  </ul>

  {prompts.length === 0 && (
    <p class="text-[var(--color-muted)]">
      No prompts found.
      {hasFilters && (
        <>
          {" "}
          <a href="/prompts/" class="text-[var(--color-accent)] hover:underline">Show all</a> to
          clear filters.
        </>
      )}
    </p>
  )}
</Layout>

<script>
  document.querySelectorAll("#filter-difficulty, #filter-author, #filter-tag").forEach((el) => {
    el.addEventListener("change", () => el.closest("form")?.submit());
  });
</script>
