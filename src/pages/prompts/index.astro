---
import Layout from "../../layouts/Layout.astro";
import { getCollection } from "astro:content";

const tagFilter = Astro.url.searchParams.get("tag");
let prompts = await getCollection("prompts", ({ data }) => data.visibility === "public");

if (tagFilter) {
	prompts = prompts.filter((p) => p.data.tags.includes(tagFilter));
}

prompts = prompts.sort(
	(a, b) => new Date(b.data.updated_at).getTime() - new Date(a.data.updated_at).getTime(),
);
---

<Layout
	title="Prompts â€” My Prompt Library"
	description="Browse all curated prompts. Filter by tag, difficulty, and author."
>
	<header class="page-header">
		<h1>Prompts</h1>
		{tagFilter && (
			<p class="filter-note">
				Filtering by tag: <strong>{tagFilter}</strong>. <a href="/prompts/">Show all</a>
			</p>
		)}
	</header>

	<ul class="prompt-list" aria-label="List of prompts">
		{prompts.map((entry) => (
			<li>
				<article class="prompt-card">
					<h2>
						<a href={`/prompts/${entry.id}/`}>{entry.data.title}</a>
					</h2>
					{entry.data.summary && <p class="summary">{entry.data.summary}</p>}
					<dl class="meta">
						<dt class="visually-hidden">Tags</dt>
						<dd class="tags">
							{entry.data.tags.map((tag) => (
								<a href={`/tags/${encodeURIComponent(tag)}/`} class="tag">{tag}</a>
							))}
						</dd>
						<dt class="visually-hidden">Difficulty</dt>
						<dd>{entry.data.difficulty}</dd>
						<dt class="visually-hidden">Author</dt>
						<dd>{entry.data.author}</dd>
					</dl>
				</article>
			</li>
		))}
	</ul>

	{prompts.length === 0 && (
		<p>No prompts found.{tagFilter && " Try removing the tag filter."}</p>
	)}
</Layout>

<style>
	.page-header {
		margin-bottom: 1.5rem;
	}

	.page-header h1 {
		font-size: 1.5rem;
		margin: 0 0 0.5rem;
	}

	.filter-note {
		font-size: 0.875rem;
		color: var(--color-text-muted);
		margin: 0;
	}

	.filter-note a {
		color: var(--color-accent);
	}

	.prompt-list {
		list-style: none;
		margin: 0;
		padding: 0;
		display: flex;
		flex-direction: column;
		gap: 1rem;
	}

	.prompt-card {
		padding: 1.25rem;
		background: var(--color-surface);
		border: 1px solid var(--color-border);
		border-radius: 0.375rem;
	}

	.prompt-card h2 {
		font-size: 1.125rem;
		margin: 0 0 0.5rem;
	}

	.prompt-card h2 a {
		color: inherit;
		text-decoration: none;
	}

	.prompt-card h2 a:hover,
	.prompt-card h2 a:focus-visible {
		color: var(--color-accent);
		text-decoration: underline;
		outline: none;
	}

	.summary {
		font-size: 0.875rem;
		color: var(--color-text-muted);
		margin: 0 0 0.75rem;
		line-height: 1.5;
	}

	.meta {
		display: flex;
		flex-wrap: wrap;
		gap: 0.75rem 1rem;
		margin: 0;
		font-size: 0.8125rem;
		color: var(--color-text-muted);
	}

	.meta dt,
	.meta dd {
		margin: 0;
	}

	.meta dd:not(.tags)::after {
		content: "";
	}

	.tags {
		display: flex;
		flex-wrap: wrap;
		gap: 0.375rem;
	}

	.tag {
		display: inline-block;
		padding: 0.2em 0.5em;
		background: var(--color-border);
		border-radius: 0.25rem;
		color: var(--color-text-muted);
		text-decoration: none;
	}

	.tag:hover,
	.tag:focus-visible {
		background: var(--color-accent);
		color: white;
		outline: none;
	}

	.visually-hidden {
		position: absolute;
		width: 1px;
		height: 1px;
		padding: 0;
		margin: -1px;
		overflow: hidden;
		clip: rect(0, 0, 0, 0);
		white-space: nowrap;
		border: 0;
	}
</style>
