---
import Layout from "../../layouts/Layout.astro";
import { getCollection, getEntry, render } from "astro:content";

export async function getStaticPaths() {
  const prompts = await getCollection("prompts", ({ data }) => data.visibility === "public");
  return prompts.map((entry) => ({
    params: { id: entry.id },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { Content, headings } = await render(entry);

const rawMarkdown = typeof entry.body === "string" ? entry.body : "";
const escapedMarkdown = rawMarkdown
  .replace(/&/g, "&amp;")
  .replace(/</g, "&lt;")
  .replace(/>/g, "&gt;")
  .replace(/"/g, "&quot;");

const title = `${entry.data.title} â€” My Prompt Library`;
const description =
  entry.data.summary ||
  (entry.data.title && `${entry.data.title}. A curated prompt from My Prompt Library.`);
const canonicalPath = `/prompts/${entry.id}/`;
const structuredData = {
  "@context": "https://schema.org",
  "@type": "Article",
  name: entry.data.title,
  description: description,
  author: { "@type": "Person", name: entry.data.author },
  dateModified: entry.data.updated_at,
  ...(Astro.site && { url: new URL(canonicalPath, Astro.site).href }),
};
---

<Layout
  title={title}
  description={description}
  canonicalPath={canonicalPath}
  structuredData={structuredData}
  ogType="article"
>
  <article class="max-w-3xl">
    <header class="mb-4">
      <h1 class="text-2xl font-semibold tracking-tight text-[var(--color-foreground)] sm:text-3xl">
        {entry.data.title}
      </h1>
    </header>

    {entry.data.summary && (
      <p class="mb-6 text-[var(--color-muted)]">{entry.data.summary}</p>
    )}

    <div class="mb-6 flex flex-wrap items-center gap-3">
      <button
        type="button"
        class="copy-button rounded-lg bg-[var(--color-accent)] px-4 py-2.5 text-sm font-medium text-white transition-opacity hover:opacity-90 focus-visible:opacity-90"
        data-copy-target="prompt-text"
        aria-describedby="copy-status"
        aria-live="polite"
      >
        Copy to clipboard
      </button>
      <span id="copy-status" class="text-sm text-[var(--color-muted)]" aria-live="polite" role="status"></span>
    </div>

    <div class="rounded-lg border border-[var(--color-border)] bg-[var(--color-surface)]" role="tablist" aria-label="Prompt view">
      <div class="flex border-b border-[var(--color-border)]">
        <button
          type="button"
          role="tab"
          id="tab-preview"
          aria-selected="true"
          aria-controls="panel-preview"
          class="prompt-tab rounded-t-lg border-b-2 border-[var(--color-accent)] bg-transparent px-4 py-3 text-sm font-medium text-[var(--color-accent)]"
        >
          Preview
        </button>
        <button
          type="button"
          role="tab"
          id="tab-markdown"
          aria-selected="false"
          aria-controls="panel-markdown"
          class="prompt-tab rounded-t-lg border-b-2 border-transparent bg-transparent px-4 py-3 text-sm font-medium text-[var(--color-muted)] hover:text-[var(--color-foreground)]"
        >
          Markdown
        </button>
      </div>

      <div
        id="panel-preview"
        role="tabpanel"
        aria-labelledby="tab-preview"
        class="prompt-tabpanel p-5"
      >
        <div class="prompt-body">
          <Content />
        </div>
      </div>

      <div
        id="panel-markdown"
        role="tabpanel"
        aria-labelledby="tab-markdown"
        class="prompt-tabpanel hidden p-5"
        hidden
      >
        <pre
          id="prompt-text"
          class="overflow-x-auto rounded bg-[var(--color-background)] p-4 text-sm leading-relaxed whitespace-pre-wrap break-words border border-[var(--color-border)]"
          aria-label="Full prompt text"
        ><code set:html={escapedMarkdown}></code></pre>
      </div>
    </div>

    <footer class="mt-8 border-t border-[var(--color-border)] pt-6">
      <dl class="grid grid-cols-[auto_1fr] gap-x-6 gap-y-1 text-sm">
        <dt class="font-medium text-[var(--color-foreground)]">Author</dt>
        <dd class="text-[var(--color-muted)]">{entry.data.author}</dd>
        <dt class="font-medium text-[var(--color-foreground)]">Difficulty</dt>
        <dd class="text-[var(--color-muted)]">{entry.data.difficulty}</dd>
        <dt class="font-medium text-[var(--color-foreground)]">Updated</dt>
        <dd class="text-[var(--color-muted)]">{new Date(entry.data.updated_at).toLocaleDateString()}</dd>
        <dt class="visually-hidden">Tags</dt>
        <dd class="col-span-2 mt-2 flex flex-wrap gap-1.5">
          {entry.data.tags.map((tag) => (
            <a
              href={`/tags/${encodeURIComponent(tag)}/`}
              class="rounded-md bg-[var(--color-border)] px-2 py-0.5 text-xs text-[var(--color-muted)] no-underline hover:bg-[var(--color-accent)] hover:text-white"
            >
              {tag}
            </a>
          ))}
        </dd>
      </dl>
    </footer>
  </article>
</Layout>

<script>
  document.querySelectorAll("[data-copy-target]").forEach((btn) => {
    const targetId = btn.getAttribute("data-copy-target");
    if (!targetId) return;
    const target = document.getElementById(targetId);
    const statusEl = document.getElementById("copy-status");
    if (!target || !statusEl) return;

    const labelCopy = "Copy to clipboard";
    const labelCopied = "Copied!";
    const labelFailed = "Copy failed";
    const resetDelay = 2000;

    btn.addEventListener("click", async () => {
      const text = target.textContent?.trim() || "";
      try {
        await navigator.clipboard.writeText(text);
        btn.textContent = labelCopied;
        btn.classList.add("!bg-[var(--color-success)]");
        statusEl.textContent = labelCopied;
      } catch {
        btn.textContent = labelFailed;
        btn.classList.add("!bg-[var(--color-error)]");
        statusEl.textContent = labelFailed;
      }
      setTimeout(() => {
        btn.textContent = labelCopy;
        btn.classList.remove("!bg-[var(--color-success)]", "!bg-[var(--color-error)]");
        statusEl.textContent = "";
      }, resetDelay);
    });
  });

  const tabs = document.querySelectorAll(".prompt-tab");
  const panels = document.querySelectorAll(".prompt-tabpanel");

  function showPanel(index) {
    tabs.forEach((tab, i) => {
      const selected = i === index;
      tab.setAttribute("aria-selected", String(selected));
      tab.classList.toggle("border-[var(--color-accent)]", selected);
      tab.classList.toggle("text-[var(--color-accent)]", selected);
      tab.classList.toggle("border-transparent", !selected);
      tab.classList.toggle("text-[var(--color-muted)]", !selected);
    });
    panels.forEach((panel, i) => {
      const visible = i === index;
      panel.classList.toggle("hidden", !visible);
      panel.hidden = !visible;
    });
  }

  tabs.forEach((tab, index) => {
    tab.addEventListener("click", () => showPanel(index));
    tab.addEventListener("keydown", (e) => {
      let next = null;
      if (e.key === "ArrowRight" || e.key === "Home") {
        next = e.key === "Home" ? 0 : Math.min(index + 1, tabs.length - 1);
      } else if (e.key === "ArrowLeft" || e.key === "End") {
        next = e.key === "End" ? tabs.length - 1 : Math.max(index - 1, 0);
      }
      if (next !== null) {
        e.preventDefault();
        showPanel(next);
        tabs[next].focus();
      }
    });
  });
</script>

<style is:global>
  .prompt-body :global(h2) {
    margin-top: 1rem;
    margin-bottom: 0.25rem;
    font-size: 1rem;
    font-weight: 600;
  }
  .prompt-body :global(p) {
    margin: 0 0 0.75rem;
  }
  .prompt-body :global(ul),
  .prompt-body :global(ol) {
    margin: 0 0 0.75rem;
    padding-left: 1.5rem;
  }
</style>
