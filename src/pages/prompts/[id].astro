---
import Layout from "../../layouts/Layout.astro";
import { getCollection, getEntry, render } from "astro:content";

export async function getStaticPaths() {
	const prompts = await getCollection("prompts", ({ data }) => data.visibility === "public");
	return prompts.map((entry) => ({
		params: { id: entry.id },
		props: { entry },
	}));
}

const { entry } = Astro.props;
const { Content, headings } = await render(entry);

const title = `${entry.data.title} â€” My Prompt Library`;
const description =
	entry.data.summary ||
	(entry.data.title && `${entry.data.title}. A curated prompt from My Prompt Library.`);
---

<Layout title={title} description={description}>
	<article class="prompt-detail">
		<header class="prompt-header">
			<h1>{entry.data.title}</h1>
			<dl class="meta">
				<dt>Author</dt>
				<dd>{entry.data.author}</dd>
				<dt>Difficulty</dt>
				<dd>{entry.data.difficulty}</dd>
				<dt>Updated</dt>
				<dd>{new Date(entry.data.updated_at).toLocaleDateString()}</dd>
				<dt class="visually-hidden">Tags</dt>
				<dd class="tags">
					{entry.data.tags.map((tag) => (
						<a href={`/tags/${encodeURIComponent(tag)}/`} class="tag">{tag}</a>
					))}
				</dd>
			</dl>
		</header>

		{entry.data.summary && <p class="summary">{entry.data.summary}</p>}

		<div class="prompt-body">
			<Content />
		</div>

		<div class="copy-section">
			<h2 id="copy-heading">Copy prompt</h2>
			<div class="copy-wrapper">
				<button
					type="button"
					class="copy-button"
					data-copy-target="prompt-text"
					aria-describedby="copy-heading copy-status"
					aria-live="polite"
				>
					Copy to clipboard
				</button>
				<span id="copy-status" class="copy-status" aria-live="polite" role="status"></span>
			</div>
			<pre id="prompt-text" class="prompt-text" aria-label="Full prompt text">{entry.body}</pre>
		</div>
	</article>
</Layout>

<script>
	document.querySelectorAll("[data-copy-target]").forEach((btn) => {
		const targetId = btn.getAttribute("data-copy-target");
		const target = document.getElementById(targetId);
		const statusEl = document.getElementById("copy-status");
		if (!target || !statusEl) return;

		btn.addEventListener("click", async () => {
			const text = target.textContent?.trim() || "";
			try {
				await navigator.clipboard.writeText(text);
				statusEl.textContent = "Copied!";
				statusEl.removeAttribute("aria-hidden");
			} catch {
				statusEl.textContent = "Copy failed";
				statusEl.removeAttribute("aria-hidden");
			}
			setTimeout(() => {
				statusEl.textContent = "";
			}, 2000);
		});
	});
</script>

<style>
	.prompt-detail {
		max-width: 48rem;
	}

	.prompt-header {
		margin-bottom: 1.5rem;
	}

	.prompt-header h1 {
		font-size: 1.5rem;
		margin: 0 0 0.75rem;
	}

	.meta {
		display: grid;
		grid-template-columns: auto 1fr;
		gap: 0.25rem 1.5rem;
		margin: 0;
		font-size: 0.875rem;
		color: var(--color-text-muted);
	}

	.meta dt {
		margin: 0;
		font-weight: 500;
		color: var(--color-text);
	}

	.meta dd {
		margin: 0;
	}

	.meta .tags {
		grid-column: 1 / -1;
		display: flex;
		flex-wrap: wrap;
		gap: 0.375rem;
		margin-top: 0.25rem;
	}

	.tag {
		display: inline-block;
		padding: 0.2em 0.5em;
		background: var(--color-border);
		border-radius: 0.25rem;
		color: var(--color-text-muted);
		text-decoration: none;
	}

	.tag:hover,
	.tag:focus-visible {
		background: var(--color-accent);
		color: white;
	}

	.summary {
		font-size: 1rem;
		color: var(--color-text-muted);
		margin: 0 0 1.5rem;
		padding-bottom: 1.5rem;
		border-bottom: 1px solid var(--color-border);
	}

	.prompt-body {
		margin-bottom: 2rem;
	}

	.prompt-body :global(h2) {
		font-size: 1.125rem;
		margin: 1.5rem 0 0.5rem;
	}

	.prompt-body :global(p) {
		margin: 0 0 0.75rem;
	}

	.prompt-body :global(ul),
	.prompt-body :global(ol) {
		margin: 0 0 0.75rem;
		padding-left: 1.5rem;
	}

	.copy-section {
		margin-top: 2rem;
		padding: 1rem;
		background: var(--color-surface);
		border: 1px solid var(--color-border);
		border-radius: 0.375rem;
	}

	.copy-section h2 {
		font-size: 1rem;
		margin: 0 0 0.5rem;
	}

	.copy-wrapper {
		display: flex;
		align-items: center;
		gap: 0.75rem;
		margin-bottom: 0.75rem;
	}

	.copy-button {
		padding: 0.5rem 1rem;
		background: var(--color-accent);
		color: white;
		border: none;
		border-radius: 0.375rem;
		font-size: 0.875rem;
		font-weight: 500;
		cursor: pointer;
	}

	.copy-button:hover,
	.copy-button:focus-visible {
		background: var(--color-accent-hover);
		outline: 2px solid var(--color-accent-hover);
		outline-offset: 2px;
	}

	.copy-status {
		font-size: 0.875rem;
		color: var(--color-text-muted);
	}

	.prompt-text {
		margin: 0;
		padding: 1rem;
		background: var(--color-bg);
		border: 1px solid var(--color-border);
		border-radius: 0.25rem;
		font-size: 0.8125rem;
		line-height: 1.6;
		white-space: pre-wrap;
		word-break: break-word;
		overflow-x: auto;
	}

	.visually-hidden {
		position: absolute;
		width: 1px;
		height: 1px;
		padding: 0;
		margin: -1px;
		overflow: hidden;
		clip: rect(0, 0, 0, 0);
		white-space: nowrap;
		border: 0;
	}
</style>
