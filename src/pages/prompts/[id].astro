---
import Layout from "../../layouts/Layout.astro";
import { getCollection, getEntry, render } from "astro:content";

export async function getStaticPaths() {
  const prompts = await getCollection("prompts", ({ data }) => data.visibility === "public");
  return prompts.map((entry) => ({
    params: { id: entry.id },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { Content, headings } = await render(entry);

const rawMarkdown = typeof entry.body === "string" ? entry.body : "";
const escapedMarkdown = rawMarkdown
  .replace(/&/g, "&amp;")
  .replace(/</g, "&lt;")
  .replace(/>/g, "&gt;")
  .replace(/"/g, "&quot;");

const title = `${entry.data.title} — My Prompt Library`;
const description =
  entry.data.summary ||
  (entry.data.title && `${entry.data.title}. A prompt from My Prompt Library.`);
const canonicalPath = `/prompts/${entry.id}/`;
const structuredData = {
  "@context": "https://schema.org",
  "@type": "Article",
  name: entry.data.title,
  description: description,
  author: { "@type": "Person", name: entry.data.author },
  dateModified: entry.data.updated_at,
  ...(Astro.site && { url: new URL(canonicalPath, Astro.site).href }),
};
---

<Layout
  title={title}
  description={description}
  canonicalPath={canonicalPath}
  structuredData={structuredData}
  ogType="article"
>
  <article class="max-w-3xl">
    <header class="mb-4">
      <h1 class="text-2xl font-semibold tracking-tight text-[var(--color-foreground)] sm:text-3xl">
        {entry.data.title}
      </h1>
    </header>

    {entry.data.summary && (
      <p class="mb-6 text-[var(--color-muted)]">{entry.data.summary}</p>
    )}

    <div class="mb-6 flex flex-wrap items-center gap-3">
      <button
        type="button"
        class="copy-button rounded-lg bg-[var(--color-accent)] px-4 py-2.5 text-sm font-medium text-white transition-colors focus-visible:opacity-90 [transition-duration:var(--duration-normal)] [transition-timing-function:var(--ease-out)] hover:opacity-90 copy-button--default"
        data-copy-target="prompt-text"
        aria-describedby="copy-status"
        aria-live="polite"
      >
        Copy to clipboard
      </button>
      <span
        id="copy-status"
        class="text-sm text-[var(--color-muted)]"
        aria-live="polite"
        role="status"
      ></span>
    </div>

    <div class="rounded-lg border border-[var(--color-border)] bg-[var(--color-surface)]" role="tablist" aria-label="Prompt view">
      <div class="flex border-b border-[var(--color-border)]">
        <button
          type="button"
          role="tab"
          id="tab-preview"
          aria-selected="true"
          aria-controls="panel-preview"
          class="prompt-tab rounded-t-lg border-b-2 border-[var(--color-accent)] bg-transparent px-4 py-3 text-sm font-medium text-[var(--color-accent)]"
        >
          Preview
        </button>
        <button
          type="button"
          role="tab"
          id="tab-markdown"
          aria-selected="false"
          aria-controls="panel-markdown"
          class="prompt-tab rounded-t-lg border-b-2 border-transparent bg-transparent px-4 py-3 text-sm font-medium text-[var(--color-muted)] hover:text-[var(--color-foreground)]"
        >
          Markdown
        </button>
      </div>

      <div
        id="panel-preview"
        role="tabpanel"
        aria-labelledby="tab-preview"
        class="prompt-tabpanel p-5"
      >
        <div class="prompt-body">
          <Content />
        </div>
      </div>

      <div
        id="panel-markdown"
        role="tabpanel"
        aria-labelledby="tab-markdown"
        class="prompt-tabpanel hidden p-5"
        hidden
      >
        <pre
          id="prompt-text"
          class="overflow-x-auto rounded bg-[var(--color-background)] p-4 text-sm leading-relaxed whitespace-pre-wrap break-words border border-[var(--color-border)]"
          aria-label="Full prompt text"
        ><code set:html={escapedMarkdown}></code></pre>
      </div>
    </div>

    <footer class="mt-8 border-t border-[var(--color-border)] pt-6">
      <dl class="grid grid-cols-[auto_1fr] gap-x-6 gap-y-1 text-sm">
        <dt class="font-medium text-[var(--color-foreground)]">Author</dt>
        <dd class="text-[var(--color-muted)]">{entry.data.author}</dd>
        <dt class="font-medium text-[var(--color-foreground)]">Difficulty</dt>
        <dd class="text-[var(--color-muted)]">{entry.data.difficulty}</dd>
        <dt class="font-medium text-[var(--color-foreground)]">Updated</dt>
        <dd class="text-[var(--color-muted)]">{new Date(entry.data.updated_at).toLocaleDateString()}</dd>
        <dt class="visually-hidden">Tags</dt>
        <dd class="col-span-2 mt-2 flex flex-wrap gap-1.5">
          {entry.data.tags.map((tag) => (
            <a
              href={`/tags/${encodeURIComponent(tag)}/`}
              class="rounded-md bg-[var(--color-border)] px-2 py-0.5 text-xs text-[var(--color-muted)] no-underline hover:bg-[var(--color-accent)] hover:text-white"
            >
              {tag}
            </a>
          ))}
        </dd>
      </dl>
    </footer>
  </article>
</Layout>

<script>
  document.querySelectorAll<HTMLButtonElement>("[data-copy-target]").forEach((btn) => {
    const targetId = btn.getAttribute("data-copy-target");
    if (!targetId) return;
    const target = document.getElementById(targetId);
    const statusEl = document.getElementById("copy-status");
    if (!target || !statusEl) return;

    const labelCopy = "Copy to clipboard";
    const labelCopied = "Copied!";
    const labelFailed = "Copy failed";
    const resetDelay = 2000;

    btn.addEventListener("click", async () => {
      const text = target.textContent?.trim() || "";
      try {
        await navigator.clipboard.writeText(text);
        btn.textContent = labelCopied;
        btn.classList.remove("copy-button--default", "copy-button--failed");
        btn.classList.add("copy-button--copied");
        statusEl.textContent = labelCopied;
      } catch {
        btn.textContent = labelFailed;
        btn.classList.remove("copy-button--default", "copy-button--copied");
        btn.classList.add("copy-button--failed");
        statusEl.textContent = labelFailed;
      }
      setTimeout(() => {
        btn.textContent = labelCopy;
        btn.classList.remove("copy-button--copied", "copy-button--failed");
        btn.classList.add("copy-button--default");
        statusEl.textContent = "";
      }, resetDelay);
    });
  });

  const tabs = document.querySelectorAll<HTMLButtonElement>(".prompt-tab");
  const panels = document.querySelectorAll<HTMLDivElement>(".prompt-tabpanel");

  function showPanel(index: number) {
    tabs.forEach((tab, i) => {
      const selected = i === index;
      tab.setAttribute("aria-selected", String(selected));
      tab.classList.toggle("border-[var(--color-accent)]", selected);
      tab.classList.toggle("text-[var(--color-accent)]", selected);
      tab.classList.toggle("border-transparent", !selected);
      tab.classList.toggle("text-[var(--color-muted)]", !selected);
    });
    panels.forEach((panel, i) => {
      const visible = i === index;
      panel.classList.toggle("hidden", !visible);
      (panel as HTMLDivElement).hidden = !visible;
    });
  }

  tabs.forEach((tab, index) => {
    tab.addEventListener("click", () => showPanel(index));
    tab.addEventListener("keydown", (e: KeyboardEvent) => {
      let next: number | null = null;
      if (e.key === "ArrowRight" || e.key === "Home") {
        next = e.key === "Home" ? 0 : Math.min(index + 1, tabs.length - 1);
      } else if (e.key === "ArrowLeft" || e.key === "End") {
        next = e.key === "End" ? tabs.length - 1 : Math.max(index - 1, 0);
      }
      if (next !== null) {
        e.preventDefault();
        showPanel(next);
        tabs[next].focus();
      }
    });
  });
</script>

<style is:global>
  .copy-button--copied {
    background-color: var(--color-success) !important;
  }
  .copy-button--copied:hover {
    opacity: 0.9;
  }
  .copy-button--failed {
    background-color: var(--color-error) !important;
  }

  /*
   * Preview pane: markdown content inside .prompt-body.
   * Use plain selectors (no :global) so compiled CSS is valid.
   */
  .prompt-body {
    font-size: 0.9375rem;
    line-height: 1.7;
    color: var(--color-foreground);
  }
  .prompt-body h1,
  .prompt-body h2,
  .prompt-body h3,
  .prompt-body h4,
  .prompt-body h5,
  .prompt-body h6 {
    color: var(--color-foreground);
    font-weight: 600;
    letter-spacing: -0.01em;
    line-height: 1.35;
  }
  .prompt-body h1 {
    font-size: 1.375rem;
    margin: 0 0 0.75rem;
  }
  .prompt-body h2 {
    font-size: 1.25rem;
    margin: 1.5rem 0 0.5rem;
    padding-bottom: 0.25rem;
  }
  .prompt-body h2:first-child {
    margin-top: 0;
  }
  .prompt-body h3 {
    font-size: 1.0625rem;
    margin: 1.25rem 0 0.375rem;
  }
  .prompt-body h4 {
    font-size: 1rem;
    margin: 1rem 0 0.25rem;
  }
  .prompt-body h5 {
    font-size: 0.9375rem;
    margin: 0.875rem 0 0.25rem;
  }
  .prompt-body h6 {
    font-size: 0.875rem;
    margin: 0.75rem 0 0.25rem;
    color: var(--color-muted);
  }
  .prompt-body p {
    margin: 0 0 0.875rem;
    color: var(--color-foreground);
  }
  .prompt-body p:last-child {
    margin-bottom: 0;
  }
  .prompt-body ul,
  .prompt-body ol {
    margin: 0 0 0.875rem;
    padding-left: 1.5rem;
  }
  .prompt-body ul {
    list-style-type: disc;
  }
  .prompt-body ol {
    list-style-type: decimal;
  }
  .prompt-body li {
    margin-bottom: 0.25rem;
  }
  .prompt-body li::marker {
    color: var(--color-muted);
  }
  .prompt-body blockquote {
    margin: 0.875rem 0;
    padding: 0.5rem 0 0.5rem 1rem;
    border-left: 3px solid var(--color-border);
    color: var(--color-muted);
    font-style: italic;
  }
  .prompt-body code {
    font-family: var(--font-mono);
    font-size: 0.875em;
    padding: 0.15em 0.4em;
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: 0.25rem;
    color: var(--color-foreground);
  }
  .prompt-body pre {
    margin: 0.875rem 0;
    padding: 1rem;
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: 0.5rem;
    overflow-x: auto;
    font-size: 0.8125rem;
    line-height: 1.6;
  }
  .prompt-body pre code {
    padding: 0;
    background: none;
    border: none;
    font-size: inherit;
  }
  /* Light theme: code must not be black on gray — use clear background and dark text */
  [data-theme="light"] .prompt-body code {
    background: #e5e7eb;
    color: #111827;
    border-color: #d1d5db;
  }
  [data-theme="light"] .prompt-body pre {
    background: #f3f4f6;
    border-color: #e5e7eb;
  }
  [data-theme="light"] .prompt-body pre code {
    color: #111827;
  }
  /* Override Astro/Shiki inline styles on fenced code blocks in light theme */
  [data-theme="light"] .prompt-body pre.astro-code {
    background: #f3f4f6 !important;
    border-color: #e5e7eb;
  }
  [data-theme="light"] .prompt-body pre.astro-code code,
  [data-theme="light"] .prompt-body pre.astro-code .line span {
    color: #111827 !important;
  }
  .prompt-body strong {
    font-weight: 600;
    color: var(--color-foreground);
  }
  .prompt-body a {
    color: var(--color-accent);
    text-decoration: underline;
    text-underline-offset: 2px;
  }
  .prompt-body a:hover {
    opacity: 0.9;
  }
  .prompt-body hr {
    margin: 1.75rem 0;
    border: none;
    border-top: 2px solid var(--color-border);
    opacity: 0.9;
  }
  .prompt-body hr:first-child {
    margin-top: 0;
  }
</style>
