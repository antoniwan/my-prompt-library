---
import Layout from "../../layouts/Layout.astro";
import { getCollection } from "astro:content";

const prompts = await getCollection("prompts", ({ data }) => data.visibility === "public");
const searchIndex = prompts.map((entry) => ({
	id: entry.id,
	title: entry.data.title,
	tags: entry.data.tags,
	summary: entry.data.summary || "",
	difficulty: entry.data.difficulty,
	author: entry.data.author,
	bodyExcerpt: typeof entry.body === "string" ? entry.body.slice(0, 800) : "",
}));
---

<Layout
	title="Search — My Prompt Library"
	description="Search prompts by keyword, tag, difficulty, or author."
>
	<header class="page-header">
		<h1>Search</h1>
		<p class="lead">Search by keyword, tag, difficulty, or author.</p>
	</header>

	<form class="search-form" role="search" aria-label="Search prompts">
		<label for="search-input" class="visually-hidden">Search prompts</label>
		<input
			id="search-input"
			type="search"
			class="search-input"
			placeholder="Type to search…"
			autocomplete="off"
			aria-describedby="search-results-label"
		/>
		<div id="search-results-label" class="visually-hidden" aria-live="polite">
			Search results update as you type.
		</div>
	</form>

	<div id="search-results" class="search-results" aria-label="Search results">
		<p id="search-initial" class="search-state">Type above to search.</p>
		<div id="search-list" class="search-list" hidden></div>
		<p id="search-empty" class="search-state" hidden>No prompts match your search.</p>
		<p id="search-error" class="search-state search-error" hidden>Search failed to load.</p>
	</div>
</Layout>

<script define:vars={{ searchIndex }}>
	import Fuse from "fuse.js";

	const form = document.querySelector(".search-form");
	const input = document.getElementById("search-input");
	const initialEl = document.getElementById("search-initial");
	const listEl = document.getElementById("search-list");
	const emptyEl = document.getElementById("search-empty");
	const errorEl = document.getElementById("search-error");

	if (!input || !listEl || !initialEl || !emptyEl) return;

	form?.addEventListener("submit", (e) => e.preventDefault());

	const index = Array.isArray(searchIndex) ? searchIndex : [];
	const fuse = new Fuse(index, {
		keys: [
			{ name: "title", weight: 0.4 },
			{ name: "summary", weight: 0.3 },
			{ name: "bodyExcerpt", weight: 0.2 },
			{ name: "tags", weight: 0.15 },
			{ name: "author", weight: 0.05 },
			{ name: "difficulty", weight: 0.05 },
		],
		threshold: 0.3,
		includeScore: true,
	});

	function renderResults(results) {
		listEl.innerHTML = "";
		listEl.hidden = true;
		initialEl.hidden = true;
		emptyEl.hidden = true;
		errorEl.hidden = true;

		if (results.length === 0) {
			emptyEl.hidden = false;
			return;
		}

		listEl.hidden = false;
		const ul = document.createElement("ul");
		ul.className = "result-list";
		ul.setAttribute("aria-label", "Search results");
		for (const { item } of results) {
			const li = document.createElement("li");
			const a = document.createElement("a");
			a.href = `/prompts/${item.id}/`;
			a.className = "result-card";
			a.innerHTML = `
				<span class="result-title">${escapeHtml(item.title)}</span>
				${item.summary ? `<span class="result-summary">${escapeHtml(item.summary)}</span>` : ""}
				<span class="result-meta">${escapeHtml(item.tags.join(", "))} · ${escapeHtml(item.difficulty)}</span>
			`;
			li.appendChild(a);
			ul.appendChild(li);
		}
		listEl.appendChild(ul);
	}

	function escapeHtml(text) {
		const div = document.createElement("div");
		div.textContent = text;
		return div.innerHTML;
	}

	input.addEventListener("input", () => {
		const q = input.value.trim();
		if (q.length === 0) {
			listEl.hidden = true;
			listEl.innerHTML = "";
			initialEl.hidden = false;
			emptyEl.hidden = true;
			return;
		}
		const results = fuse.search(q).slice(0, 25);
		renderResults(results);
	});

	input.addEventListener("focus", () => {
		if (input.value.trim().length > 0 && listEl.children.length > 0) {
			listEl.hidden = false;
		}
	});
</script>

<style>
	.page-header {
		margin-bottom: 1.5rem;
	}

	.page-header h1 {
		font-size: 1.5rem;
		margin: 0 0 0.5rem;
	}

	.lead {
		color: var(--color-text-muted);
		margin: 0;
		font-size: 0.9375rem;
	}

	.search-form {
		margin-bottom: 1.5rem;
	}

	.search-input {
		width: 100%;
		max-width: 28rem;
		padding: 0.625rem 1rem;
		font-size: 1rem;
		background: var(--color-surface);
		border: 1px solid var(--color-border);
		border-radius: 0.375rem;
		color: var(--color-text);
	}

	.search-input::placeholder {
		color: var(--color-text-muted);
	}

	.search-input:focus {
		outline: 2px solid var(--color-accent);
		outline-offset: 2px;
		border-color: var(--color-accent);
	}

	.search-results {
		min-height: 6rem;
	}

	.search-state {
		color: var(--color-text-muted);
		font-size: 0.9375rem;
		margin: 0;
	}

	.search-error {
		color: #f87171;
	}

	.result-list {
		list-style: none;
		margin: 0;
		padding: 0;
		display: flex;
		flex-direction: column;
		gap: 0.75rem;
	}

	.result-card {
		display: block;
		padding: 1rem;
		background: var(--color-surface);
		border: 1px solid var(--color-border);
		border-radius: 0.375rem;
		text-decoration: none;
		color: inherit;
	}

	.result-card:hover,
	.result-card:focus-visible {
		border-color: var(--color-accent);
		outline: none;
	}

	.result-title {
		display: block;
		font-weight: 600;
		margin-bottom: 0.25rem;
	}

	.result-summary {
		display: block;
		font-size: 0.875rem;
		color: var(--color-text-muted);
		margin-bottom: 0.25rem;
	}

	.result-meta {
		font-size: 0.75rem;
		color: var(--color-text-muted);
	}

	.visually-hidden {
		position: absolute;
		width: 1px;
		height: 1px;
		padding: 0;
		margin: -1px;
		overflow: hidden;
		clip: rect(0, 0, 0, 0);
		white-space: nowrap;
		border: 0;
	}
</style>
