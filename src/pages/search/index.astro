---
import Layout from "../../layouts/Layout.astro";
import PageHeader from "../../components/PageHeader.astro";
import {
  getPublicPrompts,
  getUniqueTags,
  getUniqueAuthors,
  DIFFICULTIES,
} from "../../data/prompts";

const prompts = await getPublicPrompts();
const searchIndex = prompts.map((entry) => ({
  id: entry.id,
  title: entry.data.title,
  tags: entry.data.tags,
  summary: entry.data.summary || "",
  difficulty: entry.data.difficulty,
  author: entry.data.author,
  bodyExcerpt: typeof entry.body === "string" ? entry.body.slice(0, 800) : "",
}));

const filterOptions = {
  tags: getUniqueTags(prompts),
  difficulties: DIFFICULTIES,
  authors: getUniqueAuthors(prompts),
};
---

<Layout
  title="Search — My Prompt Library"
  description="Search prompts by keyword, tag, difficulty, or author."
>
  <PageHeader title="Search" description="Search by keyword, tag, difficulty, or author." />

  <form class="mb-8" role="search" aria-label="Search prompts">
    <div class="mb-4">
      <label for="search-input" class="visually-hidden">Search prompts</label>
      <input
        id="search-input"
        type="search"
        class="w-full max-w-md rounded-lg border border-[var(--color-border)] bg-[var(--color-surface)] px-4 py-3 text-[var(--color-foreground)] placeholder:text-[var(--color-muted)] focus:border-[var(--color-accent)] focus:outline-none focus:ring-2 focus:ring-[var(--color-accent)]/20"
        placeholder="Type to search…"
        autocomplete="off"
        aria-describedby="search-results-label"
      />
    </div>
    <div class="flex flex-wrap items-center gap-3" aria-label="Filter results">
      <label for="filter-difficulty" class="text-sm text-[var(--color-muted)]">Difficulty</label>
      <select
        id="filter-difficulty"
        class="rounded-md border border-[var(--color-border)] bg-[var(--color-surface)] px-3 py-2 text-sm text-[var(--color-foreground)] focus:border-[var(--color-accent)]"
        aria-label="Filter by difficulty"
      >
        <option value="">All</option>
        {filterOptions.difficulties.map((d) => <option value={d}>{d}</option>)}
      </select>
      <label for="filter-author" class="text-sm text-[var(--color-muted)]">Author</label>
      <select
        id="filter-author"
        class="rounded-md border border-[var(--color-border)] bg-[var(--color-surface)] px-3 py-2 text-sm text-[var(--color-foreground)] focus:border-[var(--color-accent)]"
        aria-label="Filter by author"
      >
        <option value="">All</option>
        {filterOptions.authors.map((a) => <option value={a}>{a}</option>)}
      </select>
      <label for="filter-tag" class="text-sm text-[var(--color-muted)]">Tag</label>
      <select
        id="filter-tag"
        class="rounded-md border border-[var(--color-border)] bg-[var(--color-surface)] px-3 py-2 text-sm text-[var(--color-foreground)] focus:border-[var(--color-accent)]"
        aria-label="Filter by tag"
      >
        <option value="">All</option>
        {filterOptions.tags.map((t) => <option value={t}>{t}</option>)}
      </select>
    </div>
    <p id="search-results-label" class="visually-hidden" aria-live="polite">
      Search results update as you type.
    </p>
  </form>

  <div id="search-results" aria-label="Search results">
    <p id="search-initial" class="text-sm text-[var(--color-muted)]">Type above to search.</p>
    <div id="search-list" class="mt-4 hidden space-y-3"></div>
    <p id="search-empty" class="hidden text-sm text-[var(--color-muted)]">
      No prompts match your search.
    </p>
    <p id="search-error" class="hidden text-sm text-[var(--color-error)]">Search failed to load.</p>
  </div>
</Layout>

<script define:vars={{ searchIndex }}>
  if (typeof window !== "undefined") {
    function initSearch() {
      const form = document.querySelector('form[role="search"]');
      const input = document.getElementById("search-input");
      const filterDifficulty = document.getElementById("filter-difficulty");
      const filterAuthor = document.getElementById("filter-author");
      const filterTag = document.getElementById("filter-tag");
      const initialEl = document.getElementById("search-initial");
      const listEl = document.getElementById("search-list");
      const emptyEl = document.getElementById("search-empty");
      const errorEl = document.getElementById("search-error");

      if (!input || !listEl || !initialEl || !emptyEl || !errorEl) {
        return;
      }

      form?.addEventListener("submit", (e) => e.preventDefault());

      const allPrompts = Array.isArray(searchIndex) ? searchIndex : [];

      function normalize(value) {
        return (value ?? "").toString().toLowerCase();
      }

      function getActiveFilters() {
        const difficulty =
          filterDifficulty && "value" in filterDifficulty ? filterDifficulty.value : "";
        const author = filterAuthor && "value" in filterAuthor ? filterAuthor.value : "";
        const tag = filterTag && "value" in filterTag ? filterTag.value : "";
        return { difficulty, author, tag };
      }

      function applyFilters(items) {
        const { difficulty, author, tag } = getActiveFilters();
        if (!difficulty && !author && !tag) return items;
        return items.filter((item) => {
          if (difficulty && item.difficulty !== difficulty) return false;
          if (author && item.author !== author) return false;
          if (tag && !Array.isArray(item.tags) ? true : !item.tags.includes(tag)) return false;
          return true;
        });
      }

      function matchesQuery(item, query) {
        const q = normalize(query);
        if (!q) return true;

        if (normalize(item.title).includes(q)) return true;
        if (normalize(item.summary).includes(q)) return true;
        if (normalize(item.author).includes(q)) return true;
        if (normalize(item.difficulty).includes(q)) return true;

        if (Array.isArray(item.tags) && item.tags.some((tag) => normalize(tag).includes(q))) {
          return true;
        }

        if (normalize(item.bodyExcerpt).includes(q)) return true;

        return false;
      }

      function clearState() {
        listEl.classList.add("hidden");
        listEl.innerHTML = "";
        initialEl.classList.add("hidden");
        emptyEl.classList.add("hidden");
        errorEl.classList.add("hidden");
      }

      function renderResults(items) {
        if (!items.length) {
          emptyEl.classList.remove("hidden");
          return;
        }

        listEl.classList.remove("hidden");

        const ul = document.createElement("ul");
        ul.className = "list-none space-y-3 p-0";
        ul.setAttribute("aria-label", "Search results");

        for (const item of items) {
          const li = document.createElement("li");
          const a = document.createElement("a");
          a.href = `/prompts/${item.id}/`;
          a.className =
            "block rounded-lg border border-[var(--color-border)] bg-[var(--color-surface)] p-4 no-underline text-[var(--color-foreground)] hover:border-[var(--color-accent)]";
          a.innerHTML = `
            <span class="font-semibold">${escapeHtml(item.title)}</span>
            ${
              item.summary
                ? `<span class="mt-1 block text-sm text-[var(--color-muted)]">${escapeHtml(
                    item.summary
                  )}</span>`
                : ""
            }
            <span class="mt-2 block text-xs text-[var(--color-muted)]">${escapeHtml(
              (Array.isArray(item.tags) ? item.tags : []).join(", ")
            )}${item.difficulty ? ` · ${escapeHtml(item.difficulty)}` : ""}</span>
          `;
          li.appendChild(a);
          ul.appendChild(li);
        }

        listEl.appendChild(ul);
      }

      function runSearch() {
        const query = (input?.value ?? "").trim();
        const hasQuery = query.length > 0;
        const filtered = applyFilters(allPrompts);
        const { difficulty, author, tag } = getActiveFilters();
        const hasFilters = !!(difficulty || author || tag);

        clearState();

        if (!hasQuery && !hasFilters) {
          initialEl.classList.remove("hidden");
          return;
        }

        try {
          const results = filtered.filter((item) => matchesQuery(item, query)).slice(0, 50);
          if (!results.length) {
            emptyEl.classList.remove("hidden");
            return;
          }
          renderResults(results);
        } catch {
          errorEl.classList.remove("hidden");
        }
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = String(text);
        return div.innerHTML;
      }

      input.addEventListener("input", runSearch);
      filterDifficulty?.addEventListener("change", runSearch);
      filterAuthor?.addEventListener("change", runSearch);
      filterTag?.addEventListener("change", runSearch);
    }

    if (document.readyState === "loading") {
      window.addEventListener("DOMContentLoaded", initSearch, { once: true });
    } else {
      initSearch();
    }
  }
</script>
