---
import Layout from "../../layouts/Layout.astro";
import PageHeader from "../../components/PageHeader.astro";
import PromptCard from "../../components/PromptCard.astro";
import { getPublicPrompts, getUniqueTags } from "../../data/prompts";
import { SITE_NAME, SITE_URL } from "../../data/site";
import { tagsIndex, tagDetail, home } from "../../utils/urls";

export async function getStaticPaths() {
  const prompts = await getPublicPrompts();
  const tagSlugs = getUniqueTags(prompts);
  return tagSlugs.map((tag) => ({
    params: { tag },
    props: { tag },
  }));
}

const { tag } = Astro.props;
const allPrompts = await getPublicPrompts();
const prompts = allPrompts.filter((entry) => entry.data.tags.includes(tag));

const canonicalPath = tagDetail(tag);
const siteBase = (Astro.site?.href ?? SITE_URL).replace(/\/$/, "");
const pageUrl = `${siteBase}${canonicalPath}`;

const breadcrumbList = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  itemListElement: [
    { "@type": "ListItem", position: 1, name: "Home", item: `${siteBase}${home()}` },
    { "@type": "ListItem", position: 2, name: "Tags", item: `${siteBase}${tagsIndex()}` },
    { "@type": "ListItem", position: 3, name: tag, item: pageUrl },
  ],
};

const collectionPage = {
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  name: `Prompts tagged with ${tag} — ${SITE_NAME}`,
  description: `Prompts tagged with ${tag}.`,
  url: pageUrl,
  ...(prompts.length > 0 && {
    mainEntity: {
      "@type": "ItemList",
      numberOfItems: prompts.length,
      itemListElement: prompts.slice(0, 30).map((entry, i) => ({
        "@type": "ListItem",
        position: i + 1,
        url: `${siteBase}/prompts/${entry.id}/`,
        name: entry.data.title,
      })),
    },
  }),
};

const structuredData = [collectionPage, breadcrumbList];
---

<Layout
  title={`${tag} — Tags — ${SITE_NAME}`}
  description={`Prompts tagged with ${tag}.`}
  canonicalPath={canonicalPath}
  structuredData={structuredData}
  keywords={tag}
>
  <PageHeader title={`Tag: ${tag}`}>
    <p class="m-0">
      <a href={tagsIndex()} class="text-[var(--color-accent)] hover:underline">All tags</a>
      {" · "}
      {prompts.length} prompt{prompts.length === 1 ? "" : "s"}
    </p>
  </PageHeader>

  <ul class="list-none space-y-4 p-0" aria-label={`Prompts tagged with ${tag}`}>
    {
      prompts.map((entry) => (
        <li>
          <PromptCard entry={entry} showTags={false} />
        </li>
      ))
    }
  </ul>
</Layout>
