---
import Layout from "../../layouts/Layout.astro";
import PageHeader from "../../components/PageHeader.astro";
import PromptCard from "../../components/PromptCard.astro";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
  const prompts = await getCollection("prompts", ({ data }) => data.visibility === "public");
  const tagSet = new Set<string>();
  for (const entry of prompts) {
    for (const tag of entry.data.tags) {
      tagSet.add(tag);
    }
  }
  return Array.from(tagSet).map((tag) => ({
    params: { tag },
    props: { tag },
  }));
}

const { tag } = Astro.props;
const allPrompts = await getCollection("prompts", ({ data }) => data.visibility === "public");
const prompts = allPrompts
  .filter((entry) => entry.data.tags.includes(tag))
  .sort((a, b) => new Date(b.data.updated_at).getTime() - new Date(a.data.updated_at).getTime());
---

<Layout
  title={`${tag} — Tags — My Prompt Library`}
  description={`Prompts tagged with ${tag}.`}
>
  <PageHeader title={`Tag: ${tag}`}>
    <p class="m-0">
      <a href="/tags/" class="text-[var(--color-accent)] hover:underline">All tags</a>
      {" · "}
      {prompts.length} prompt{prompts.length === 1 ? "" : "s"}
    </p>
  </PageHeader>

  <ul class="list-none space-y-4 p-0" aria-label={`Prompts tagged with ${tag}`}>
    {prompts.map((entry) => (
      <li>
        <PromptCard entry={entry} showTags={false} />
      </li>
    ))}
  </ul>
</Layout>
