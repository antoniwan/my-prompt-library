---
import Layout from "../../layouts/Layout.astro";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
	const prompts = await getCollection("prompts", ({ data }) => data.visibility === "public");
	const tagSet = new Set<string>();
	for (const entry of prompts) {
		for (const tag of entry.data.tags) {
			tagSet.add(tag);
		}
	}
	return Array.from(tagSet).map((tag) => ({
		params: { tag },
		props: { tag },
	}));
}

const { tag } = Astro.props;
const allPrompts = await getCollection("prompts", ({ data }) => data.visibility === "public");
const prompts = allPrompts
	.filter((entry) => entry.data.tags.includes(tag))
	.sort((a, b) => new Date(b.data.updated_at).getTime() - new Date(a.data.updated_at).getTime());
---

<Layout
	title={`${tag} — Tags — My Prompt Library`}
	description={`Prompts tagged with ${tag}.`}
>
	<header class="page-header">
		<h1>Tag: {tag}</h1>
		<p class="lead">
			<a href="/tags/">All tags</a> · {prompts.length} prompt{prompts.length === 1 ? "" : "s"}
		</p>
	</header>

	<ul class="prompt-list" aria-label={`Prompts tagged with ${tag}`}>
		{prompts.map((entry) => (
			<li>
				<article class="prompt-card">
					<h2>
						<a href={`/prompts/${entry.id}/`}>{entry.data.title}</a>
					</h2>
					{entry.data.summary && <p class="summary">{entry.data.summary}</p>}
					<p class="meta">
						{entry.data.difficulty} · {entry.data.author}
					</p>
				</article>
			</li>
		))}
	</ul>
</Layout>

<style>
	.page-header {
		margin-bottom: 1.5rem;
	}

	.page-header h1 {
		font-size: 1.5rem;
		margin: 0 0 0.5rem;
	}

	.lead {
		color: var(--color-text-muted);
		margin: 0;
		font-size: 0.9375rem;
	}

	.lead a {
		color: var(--color-accent);
		text-decoration: none;
	}

	.lead a:hover,
	.lead a:focus-visible {
		text-decoration: underline;
	}

	.prompt-list {
		list-style: none;
		margin: 0;
		padding: 0;
		display: flex;
		flex-direction: column;
		gap: 1rem;
	}

	.prompt-card {
		padding: 1.25rem;
		background: var(--color-surface);
		border: 1px solid var(--color-border);
		border-radius: 0.375rem;
	}

	.prompt-card h2 {
		font-size: 1.125rem;
		margin: 0 0 0.5rem;
	}

	.prompt-card h2 a {
		color: inherit;
		text-decoration: none;
	}

	.prompt-card h2 a:hover,
	.prompt-card h2 a:focus-visible {
		color: var(--color-accent);
		text-decoration: underline;
		outline: none;
	}

	.summary {
		font-size: 0.875rem;
		color: var(--color-text-muted);
		margin: 0 0 0.5rem;
	}

	.meta {
		font-size: 0.8125rem;
		color: var(--color-text-muted);
		margin: 0;
	}
</style>
